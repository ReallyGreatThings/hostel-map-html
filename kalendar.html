<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title></title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300&subset=latin,cyrillic' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/jquery-ui.css">
    <link rel="stylesheet" href="css/fullcalendar.css">

    <script src="js/vendor/modernizr-2.6.2.min.js"></script>
    <!--<script src="//api-maps.yandex.ru/2.1-dev/?lang=ru-RU&load=package.full" type="text/javascript"></script>-->
</head>
<body>
<!--[if lt IE 7]>
<p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
<![endif]-->

<!-- header block begin -->
<header class="pageHeader">
    <div class="pageHeaderWrapper clearfix">
        <div class="logo">
            <a href="/"><img src="img/logo.png" alt="" width="132" height="27"/></a>
        </div>
        <div class="headerClient">
            <a href="#" class="headerClientLogin">Войти</a>
        </div>
    </div>
</header>
<!-- header block end -->


<!-- content block begin -->
<div class="c-align content-wrap">
    <ul class="tabs-navigation-menu clearfix">
        <li><a href="#">Заявки (4)</a></li>
        <li class="current"><a href="#">Календарь</a></li>
        <li><a href="#">Описание</a></li>
        <li><a href="#">Баланс</a></li>
    </ul>
    <div class="page-content-wrap">
        <div id="calendar"></div>
        <div id="dialogForm" class="dialogForm" style="display: none;position: absolute;">
            <form action="#" method="get" id="dialogFormAct">
                <div class="dialogFormField clearfix">
                    <input type="text" class="dialogFormStart" id="dialogFormDateStartFormat" value=""/>
                    <input type="text" class="dialogFormEnd" id="dialogFormDateEndFormat" value=""/>
                </div>
                <div class="dialogFormField clearfix">
                    <label for="dialogFormPrice">Цена</label>
                    <input type="text" id="dialogFormPrice" value=""/>
                </div>
                <div class="clearfix">
                    <button type="reset" class="dialogFormCansel">Отменить</button>
                    <button type="submit" class="dialogFormSave">Сохранить</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- content block end -->

<!-- footer block begin -->
<footer class="site-footer-wrap clearfix">
    <div class="col-a">
        <p>2013 <a href="#">HOSTELMAP.RU</a></p>
    </div>
    <div class="col-b">
        <ul class="footer-nav-menu clearfix">
            <li><a href="#">хостелам</a></li>
            <li><a href="#">о нас</a></li>
            <li><a href="#">контакты</a></li>
        </ul>
    </div>
</footer>
<!-- footer block end -->
<script src="js/lib/moment.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="js/fullcalendar.js"></script>
<script src="http://code.jquery.com/ui/1.10.4/jquery-ui.min.js"></script>
<script src="js/jquery.slides.min.js"></script>
<script src="js/main.js"></script>

<script>
function setCellHeight(){
    var element = $('.fc-day-wrapper');
    var rowHeight = element.eq(0).width();
    element.height(rowHeight);
}

$(document).ready(function() {

    $('#dialogFormDateStartFormat, #dialogFormDateEndFormat').datepicker({
        dateFormat: 'yy-mm-dd'
    });

    function setDialogFormCord(num){
        var cell = $('.fc-day.dateFix').eq(num);
        var formTop = cell.offset().top + cell.height() + 10;
        var formLeft = cell.offset().left - (cell.width()/2);
        $('#dialogForm').css('left', formLeft).css('top', formTop);
    }

    function setDialogFormValues(start, end, price){

        var startDate = new Date(start);
        var endDate = new Date(end);

        if((startDate - endDate) > 0) {
            $('#dialogFormDateStartFormat').val(end);
            $('#dialogFormDateEndFormat').val(start);
        }else{
            $('#dialogFormDateStartFormat').val(start);
            $('#dialogFormDateEndFormat').val(end);
        }

        $('#dialogFormPrice').val(price);
    }

    $('#dialogFormDateStartFormat, #dialogFormDateEndFormat').on('change', function(){

        var start = $('#dialogFormDateStartFormat').val();
        var end = $('#dialogFormDateEndFormat').val();

        selectStartDate = start;
        selectEndDate = end;

        hightlightFix(end);
    });

    function showDialogForm(price, start, end){

        var selectedCount = 0;
        $('.fc-day').each(function(){
            if($(this).data('date') >= start && $(this).data('date') <= end){
                selectedCount ++;
            }
        });

        setDialogFormCord(Math.round((selectedCount)/2)-1);
        setDialogFormValues(start, end, price);
        $('#dialogForm').show();

    }

    $('#dialogFormAct .dialogFormCansel').click(function(){
        selectStartDate = '';
        selectEndDate = '';
        calendar.fullCalendar( 'unselect' );
        $('#dialogForm').hide();
    });

    $('#dialogFormAct .dialogFormSave').click(function(e){

        var startDate = new Date($('#dialogFormDateStartFormat').val());
        var endDate = new Date($('#dialogFormDateEndFormat').val());

        while(endDate.valueOf() >= startDate.valueOf()){
            var isAdd = true;
            calendar.fullCalendar('clientEvents', function (event) {

                if(startDate.valueOf() == event.start.valueOf()){
                    event.title = $('#dialogFormPrice').val();
                    calendar.fullCalendar('updateEvent', event);
                    isAdd = false;
                }

            });

            if(isAdd){
                calendar.fullCalendar('renderEvent', {
                    title: $('#dialogFormPrice').val(),
                    start: startDate,
                    allDay: true
                });
            }

            startDate.setDate(startDate.getDate()+1);
        }

        selectStartDate = '';
        selectEndDate = '';

        calendar.fullCalendar('unselect');
        $('#dialogForm').hide();
        e.preventDefault();
    });

    //select range fix
    var selectStartDate = '';
    var selectEndDate = '';

    function selectRangeFix(date, event, element){
        if(selectStartDate == '' && selectEndDate == ''){
            selectStartDate = date.format();
            var el = $('td.fc-day[data-date="'+date.format()+'"]').addClass('startFix dateFix');
            el.next().addClass('endFix');
        }else{
            selectEndDate = date.format();
        }

        if(selectStartDate != '' && selectEndDate != ''){
            calendar.fullCalendar('unselect');
            calendar.fullCalendar('select', selectStartDate, selectEndDate);
            var price = '';
            calendar.fullCalendar('clientEvents', function (event) {
                if (event.start.format() == selectStartDate) {
                    price = event.title;
                }
            });

            hightlightFix(selectEndDate);
            showDialogForm(price, selectStartDate, selectEndDate);

            selectStartDate = '';
            selectEndDate = '';
        }

    }

    function addZero(i) {
        return (i < 10)? "0" + i: i;
    }

    function hightlightFix(end){

        if(selectStartDate != '' && end != ''){
            var start = selectStartDate;
            var startDate = new Date(start);
            var endDate = new Date(end);


            $('td.fc-day').removeClass('dateFix').removeClass('startFix').removeClass('endFix');

            if((startDate - endDate) > 0) {

                var startDate =  new Date(end);
                var endDate = new Date(start);

                while(endDate.valueOf() >= startDate.valueOf()){
                    var selectDate = startDate.getFullYear() + '-' + addZero(parseInt(startDate.getMonth())+1) + '-' + addZero(startDate.getDate());
                    $('td.fc-day[data-date="'+selectDate+'"]').addClass('dateFix');
                    startDate.setDate(startDate.getDate()+1);
                }
                $('td.fc-day[data-date="'+start+'"]').next().addClass('endFix');
                $('.dateFix:first').addClass('startFix dateFix');

            }else{

                while(endDate.valueOf() >= startDate.valueOf()){
                    var selectDate = startDate.getFullYear() + '-' + addZero(parseInt(startDate.getMonth())+1) + '-' + addZero(startDate.getDate());
                    $('td.fc-day[data-date="'+selectDate+'"]').addClass('dateFix');
                    startDate.setDate(startDate.getDate()+1);
                }

                $('td.fc-day[data-date="'+start+'"]').addClass('startFix').addClass('dateFix');
                $('.dateFix:last').next().addClass('endFix');

            }

        }

    }

    $(document).on('mouseenter', '.fc-day', function(e){
        if(selectStartDate != '' && selectEndDate == ''){
            hightlightFix($(this).data('date'));
        }
    });
    //select range fix


    var date = new Date();
    var d = date.getDate();
    var m = date.getMonth();
    var y = date.getFullYear();

    var calendar = $('#calendar').fullCalendar({
        header: {
            left: 'prev',
            center: 'title',
            right: 'next'
        },
        monthNames: ['Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'],
        monthNamesShort: ['Янв.','Фев.','Март','Апр.','Май','Июнь','Июль','Авг.','Сент.','Окт.','Ноя.','Дек.'],
        dayNames: ["Воскресенье","Понедельник","Вторник","Среда","Четверг","Пятница","Суббота"],
        dayNamesShort: ["ВС","ПН","ВТ","СР","ЧТ","ПТ","СБ"],
        firstDay: 1,
        disableDragging: true,
        selectable: true,
        eventTextColor: '#fff',
        eventBackgroundColor: 'transparent',
        eventBorderColor: 'transparent',
        unselectCancel: '#dialogForm, .ui-datepicker',
        unselect: function(){
            $('#dialogForm').hide();
        },
        dayClick: function(date, jsEvent, view){
            selectRangeFix(date, jsEvent, view);
        },
        viewRender: function(view, element){
            setCellHeight();
        },
        eventRender: function(event, element){
            $('.fc-day[data-date="'+event.start.format()+'"]').find('.fc-day-content span').text(event.title);
        },
        events: [
            {
                title: '2000р.',
                start: new Date(y, m, 1),
                end: new Date(y, m, 1),
                allDay: true
            },
            {
                title: '3000р.',
                start: new Date(y, m, 2),
                end: new Date(y, m, 2),
                allDay: true
            },
            {
                title: '4000р.',
                start: new Date(y, m, 3),
                end: new Date(y, m, 3),
                allDay: true
            },
            {
                title: '1000р.',
                start: new Date(y, m, 4),
                end: new Date(y, m, 4),
                allDay: true
            },
            {
                title: '1000р.',
                start: new Date(y, m, 5),
                end: new Date(y, m, 5),
                allDay: true
            },
            {
                title: '1000р.',
                start: new Date(y, m, 6),
                end: new Date(y, m, 6),
                allDay: true
            },
            {
                title: '1000р.',
                start: new Date(y, m, 7),
                end: new Date(y, m, 7),
                allDay: true
            },
            {
                title: '1000р.',
                start: new Date(y, m, 8),
                end: new Date(y, m, 8),
                allDay: true
            },
            {
                title: '1000р.',
                start: new Date(y, m, 9),
                end: new Date(y, m, 9),
                allDay: true
            },
            {
                title: '1000р.',
                start: new Date(y, m, 10),
                end: new Date(y, m, 10),
                allDay: true
            }
        ]
    });
});

</script>
</body>
</html>
